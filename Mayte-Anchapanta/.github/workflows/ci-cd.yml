name: CI/CD Pipeline - Mayte-Anchapanta

on:
  push:
    branches: [ rama-Mayte-Anchapanta ]
    paths:
      - 'proyecto-Mayte-Anchapanta/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'proyecto-Mayte-Anchapanta/**'

jobs:
  test:
    name: üß™ Ejecutar Pruebas Unitarias
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout del c√≥digo
      uses: actions/checkout@v3
    
    - name: üêç Configurar Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: üì¶ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
        echo "‚úÖ Dependencias instaladas correctamente"
    
    - name: üß™ Ejecutar pruebas unitarias
      working-directory: ./proyecto-Mayte-Anchapanta
      run: |
        echo "Iniciando pruebas..."
        python tests/test_app.py
        echo ""
        echo "Ejecutando pytest con cobertura..."
        pytest tests/ -v --cov=src --cov-report=term-missing
    
    - name: ‚úÖ Verificar calidad del c√≥digo
      run: |
        echo "=========================================="
        echo "‚úÖ TODAS LAS PRUEBAS PASARON EXITOSAMENTE"
        echo "=========================================="

  build:
    name: üì¶ Construir Package
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout del c√≥digo
      uses: actions/checkout@v3
    
    - name: üêç Configurar Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: üîß Instalar herramientas de construcci√≥n
      run: |
        python -m pip install --upgrade pip
        pip install build setuptools wheel
        echo "‚úÖ Herramientas de build instaladas"
    
    - name: üìù Crear archivo setup.py
      working-directory: ./proyecto-Mayte-Anchapanta
      run: |
        cat > setup.py << 'EOF'
        from setuptools import setup, find_packages
        
        setup(
            name="calculadora-cicd-Mayte-Anchapanta",
            version="1.0.0",
            author="Mayte-Anchapanta",
            author_email="mav.anchapanta@yavirac.edu.ec",
            description="Calculadora simple con CI/CD - Proyecto DevOps",
            long_description=open("README.md").read(),
            long_description_content_type="text/markdown",
            packages=find_packages(),
            python_requires='>=3.7',
            classifiers=[
                "Programming Language :: Python :: 3",
                "License :: OSI Approved :: MIT License",
                "Operating System :: OS Independent",
            ],
        )
        EOF
        echo "‚úÖ setup.py creado correctamente"
    
    - name: üèóÔ∏è Construir el package
      working-directory: ./proyecto-Mayte-Anchapanta
      run: |
        echo "Iniciando construcci√≥n del package..."
        python -m build
        echo ""
        echo "=========================================="
        echo "üì¶ PACKAGE CONSTRUIDO EXITOSAMENTE"
        echo "=========================================="
        echo ""
        echo "üìÇ Archivos generados:"
        ls -lh dist/
    
    - name: üì§ Subir artefactos (package)
      uses: actions/upload-artifact@v3
      with:
        name: package-distribution-Mayte-Anchapanta
        path: proyecto-Mayte-Anchapanta/dist/
        retention-days: 30
    
    - name: üéâ Resumen del Build
      run: |
        echo ""
        echo "=========================================="
        echo "‚úÖ CI/CD PIPELINE COMPLETADO EXITOSAMENTE"
        echo "=========================================="
        echo "Proyecto: calculadora-cicd-Mayte-Anchapanta"
        echo "Autor: Mayte-Anchapanta"
        echo "Fecha: $(date)"
        echo "=========================================="